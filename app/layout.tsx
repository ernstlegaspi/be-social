import dynamic from 'next/dynamic'
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import { Toaster } from 'react-hot-toast'

import './globals.css'

import QueryProvider from '@/lib/providers/QueryProvider'
import SessionProvider from '@/lib/providers/SessionProvider'

import { getServerSession } from 'next-auth'
import { authOptions } from './api/auth/[...nextauth]/route'
import getUser from '@/actions/getUser'

const inter = Inter({ subsets: ['latin'] })

const FriendsBar = dynamic(() => import('@/components/friendsbar/FriendsBar'))
const LeftSidebar = dynamic(() => import('@/components/leftsidebar/LeftSidebar'))
const Modals = dynamic(() => import('@/components/modals/Modals'))
const Navbar = dynamic(() => import('@/components/navbar/Navbar'))
const RightTabs = dynamic(() => import('@/components/righttabs/RightTabs'))

export const metadata: Metadata = {
	title: 'Huddle',
	description: 'Generated by create next app'
}

export default async function RootLayout({ children }: { children: React.ReactNode }) {
	const session = await getServerSession(authOptions)
	let user = null

	if(session) user = await getUser(session?.user?.email as string)

	return (
		<SessionProvider>
			<QueryProvider>
				<html lang="en">
					<body className={`${inter.className} ${session ? 'bg-lg' : 'bg-vio'}`}>
						<Toaster />
						<div className="max-w-[1920px] mx-auto h-[100vh] flex flex-col">
							{session ? <Navbar /> : null}
							{!session ? children : <div className="flex flex-1">
								<LeftSidebar />
								{children}
								<RightTabs />
								<FriendsBar />
							</div>}
						</div>
						<Modals user={user as User} />
					</body>
				</html>
			</QueryProvider>
		</SessionProvider>
	)
}
